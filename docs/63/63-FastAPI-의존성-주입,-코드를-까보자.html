
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>FastAPI 의존성 주입, 코드를 까보자</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">FastAPI 의존성 주입, 코드를 까보자</h2>
                                <div class="box-info">
                                    <p class="category">탐구 생활/FastAPI</p>
                                    <p class="date">2024-12-04 20:47:28</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p><figure class="imageblock alignCenter" width="350" height="350" >
    <span data-lightbox="lightbox">
        <img src="./img/fastapi-di.webp" width="350" height="350"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16"><a href="https://probehub.tistory.com/62" target="_blank" rel="noopener">이전 글</a>에서 FastAPI 가 제공하는 의존성 주입 기능을 알아보았다. 하지만 그정도는 어떻게 쓰는지 알아보는 정도이고 아직 풀리지 않는 궁금증이 많다.</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">"어떻게 Callable 만 받아들이는가?"</p>
<p data-ke-size="size16">"서브-의존성 을 구현하는 방법은 무엇인가?"</p>
<p data-ke-size="size16">"왜 FastAPI 경로 동작 함수(path operation function)에서만 동작하는가?"</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">이런 궁금증을 풀기 위해서는 직접 코드를 까보는게 최고다.&nbsp;</p>
<hr contenteditable="false" data-ke-type="horizontalRule" data-ke-style="style6" />
<p data-ke-size="size16">&nbsp;</p>
<h3 data-ke-size="size23"><b>fastapi.param_functions.Depends</b></h3>
<p data-ke-size="size16">코드를 까본 결과 직접 FastAPI 경로 작업 함수(path opration function)에서 참조하는 Depends 는 use_caches 기능이 있었다!&nbsp; 그리고 내부적으로 params.Depenndes 를 호출하여 파라미터를 그대로 전달하는 동작을 한다.</p>
<p data-ke-size="size16">&nbsp;</p>
<pre id="code_1733359189354" class="python" data-ke-language="python" data-ke-type="codeblock"><code>def Depends(  # noqa: N802
    dependency: Annotated[
        Optional[Callable[..., Any]],
        Doc(
            """
            A "dependable" callable (like a function).

            Don't call it directly, FastAPI will call it for you, just pass the object
            directly.
            """
        ),
    ] = None,
    *,
    use_cache: Annotated[
        bool,
        Doc(
            """
            By default, after a dependency is called the first time in a request, if
            the dependency is declared again for the rest of the request (for example
            if the dependency is needed by several dependencies), the value will be
            re-used for the rest of the request.

            Set `use_cache` to `False` to disable this behavior and ensure the
            dependency is called again (if declared more than once) in the same request.
            """
        ),
    ] = True,
) -&gt; Any:

    return params.Depends(dependency=dependency, use_cache=use_cache)</code></pre>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">여기까지 코드를 깠을때는 내부동작을 확인하기는 어렵지만, <b>API 작성 팁</b>을 확인할 수 있었다.</p>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>typing_extension.py 의 Doc 이라는 클래스를 통해 더 명시적으로 파라미터에 대한 설명을 작성할 수 있다는 것이다.</li>
<li>함수 인수(function parameter) 에 * 를 명시한 이후의 인수는 무조건 키워드 인수(keyword parameter) 로 구성된다. <a href="https://docs.python.org/3/tutorial/controlflow.html#special-parameters" target="_blank" rel="noopener">파이썬 공식 문서</a>를 읽어보면 더 다양한 팁을 확인할 수 있다.</li>
</ul>
<p data-ke-size="size16">API 작석 팁을 배운것 좋지만 뭔가 아쉽다. Depends 가 호출하는 params.Depends 를 파고 들어가보자, 특히 use_caches 를 사용하면 어디에 캐시가 되고 어떨때 사용하는게 좋은지도 궁금해진다.</p>
<hr contenteditable="false" data-ke-type="horizontalRule" data-ke-style="style6" />
<h3 data-ke-size="size23"><b>fastapi.params.Depndes</b></h3>
<p data-ke-size="size16">잔뜩 기대를 안고 열어본 fastapi.params.Depndes 는 단순한 class 였다. __repr__</p>
<pre id="code_1733359212650" class="python" data-ke-language="python" data-ke-type="codeblock"><code>class Depends:
    def __init__(
        self, dependency: Optional[Callable[..., Any]] = None, *, use_cache: bool = True
    ):
        self.dependency = dependency
        self.use_cache = use_cache

    def __repr__(self) -&gt; str:
        attr = getattr(self.dependency, "__name__", type(self.dependency).__name__)
        cache = "" if self.use_cache else ", use_cache=False"
        return f"{self.__class__.__name__}({attr}{cache})"</code></pre>
                        </div>
                        <br/>
                        <div class="tags">
                            
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
